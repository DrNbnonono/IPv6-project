<template>
  <div class="vulnerability-management-form">
    <!-- å…¨å±€æ¶ˆæ¯æç¤º -->
    <div v-if="globalError" class="error-message global-error">{{ globalError }}</div>
    <div v-if="globalSuccess" class="success-message global-success">{{ globalSuccess }}</div>

    <!-- ç¬¬ä¸€éƒ¨åˆ†: æ¼æ´å®šä¹‰ç®¡ç† -->
    <section class="vulnerability-definitions-section card">
      <h3 class="card-header">
        <i class="icon-list"></i> æ¼æ´å®šä¹‰ç®¡ç†
        <button @click="openVulnerabilityModal('create')" class="btn btn-sm btn-success float-right">
          <i class="icon-plus"></i> æ·»åŠ æ–°æ¼æ´
        </button>
      </h3>
      <div class="card-body">
        <div v-if="definitionsLoading" class="loading-message">åŠ è½½æ¼æ´å®šä¹‰åˆ—è¡¨ä¸­...</div>
        <div v-else>
          <table v-if="vulnerabilityDefinitions && vulnerabilityDefinitions.length > 0" class="table table-striped table-hover">
            <thead>
              <tr>
                <th>CVE ID</th>
                <th>æ¼æ´åç§°</th>
                <th>ä¸¥é‡ç¨‹åº¦</th>
                <th>å½±å“åè®®</th>
                <th>å‘å¸ƒæ—¥æœŸ</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="vuln in vulnerabilityDefinitions" :key="vuln.vulnerability_id">
                <td>{{ vuln.cve_id }}</td>
                <td>{{ vuln.name }}</td>
                <td>
                  <span class="severity-badge" :class="'severity-' + vuln.severity.toLowerCase()">
                    {{ getSeverityText(vuln.severity) }}
                  </span>
                </td>
                <td>{{ vuln.affected_protocols || '-' }}</td>
                <td>{{ formatDate(vuln.published_date) || '-' }}</td>
                <td>
                  <button @click="openVulnerabilityModal('edit', vuln)" class="btn btn-sm btn-info mr-1">
                    <i class="icon-edit"></i> ç¼–è¾‘
                  </button>
                  <button @click="confirmDeleteVulnerability(vuln)" class="btn btn-sm btn-danger">
                    <i class="icon-delete"></i> åˆ é™¤
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <p v-else-if="!storeError">æš‚æ— æ¼æ´å®šä¹‰æ•°æ®ã€‚è¯·æ·»åŠ æ–°æ¼æ´ã€‚</p>
          <!-- Display storeError if it occurred during definitions fetch and definitions are empty -->
          <p v-if="storeError && (!vulnerabilityDefinitions || vulnerabilityDefinitions.length === 0)" class="error-message">
            åŠ è½½æ¼æ´å®šä¹‰å¤±è´¥: {{ storeError }}
          </p>
        </div>
      </div>
    </section>

    <!-- æ¼æ´å®šä¹‰ç¼–è¾‘/åˆ›å»ºæ¨¡æ€æ¡† -->
    <div v-if="showVulnerabilityModal" class="modal-overlay" @click.self="closeVulnerabilityModal">
      <div class="modal-content">
        <h4>{{ modalMode === 'create' ? 'æ·»åŠ æ–°æ¼æ´' : 'ç¼–è¾‘æ¼æ´' }}</h4>
        <form @submit.prevent="handleSaveVulnerabilityDefinition">
          <div class="form-group">
            <label for="vuln-cve">CVE ID <span class="required">*</span></label>
            <input type="text" id="vuln-cve" v-model="currentVulnerability.cve_id" required />
          </div>
          <div class="form-group">
            <label for="vuln-name">æ¼æ´åç§° <span class="required">*</span></label>
            <input type="text" id="vuln-name" v-model="currentVulnerability.name" required />
          </div>
          <div class="form-group">
            <label for="vuln-description">æè¿°</label>
            <textarea id="vuln-description" v-model="currentVulnerability.description"></textarea>
          </div>
          <div class="form-group">
            <label for="vuln-severity">ä¸¥é‡ç¨‹åº¦ <span class="required">*</span></label>
            <select id="vuln-severity" v-model="currentVulnerability.severity" required>
              <option value="low">ä½</option>
              <option value="medium">ä¸­</option>
              <option value="high">é«˜</option>
              <option value="critical">ä¸¥é‡</option>
            </select>
          </div>
          <div class="form-group">
            <label for="vuln-affected-protocols">å½±å“åè®® (é€—å·åˆ†éš”)</label>
            <input type="text" id="vuln-affected-protocols" v-model="currentVulnerability.affected_protocols" />
          </div>
           <div class="form-group">
            <label for="vuln-detection-method">æ£€æµ‹æ–¹æ³•</label>
            <input type="text" id="vuln-detection-method" v-model="currentVulnerability.detection_method" />
          </div>
          <div class="form-group">
            <label for="vuln-published-date">å‘å¸ƒæ—¥æœŸ</label>
            <input type="date" id="vuln-published-date" v-model="currentVulnerability.published_date" />
          </div>
          <div v-if="modalError" class="error-message">{{ modalError }}</div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" :disabled="modalSubmitting">
              {{ modalSubmitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
            </button>
            <button type="button" class="btn btn-secondary" @click="closeVulnerabilityModal" :disabled="modalSubmitting">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ç¬¬äºŒéƒ¨åˆ†: æ‰¹é‡æ›´æ–°ASNæ¼æ´å—å½±å“åœ°å€æ•° -->
    <section class="batch-update-section card mt-4">
      <h3 class="card-header">
        <i class="icon-update"></i> æ‰¹é‡æ›´æ–°ASNæ¼æ´å—å½±å“åœ°å€æ•°
      </h3>
      <div class="card-body">
        <div class="batch-operations-table">
          <div class="batch-operations-header">
            <div>æ¼æ´ <span class="required">*</span></div>
            <div>å›½å®¶ <span class="required">*</span></div>
            <div>ASN <span class="required">*</span></div>
            <div>æ“ä½œ <span class="required">*</span></div>
            <div>æ•°å€¼ <span class="required">*</span></div>
            <div></div> <!-- ç”¨äºåˆ é™¤æŒ‰é’®åˆ— -->
          </div>
          <div v-for="(op, index) in batchUpdateOperations" :key="op.id" class="batch-operation-row">
            <!-- æ¼æ´é€‰æ‹© -->
            <div class="form-group">
              <select v-model="op.vulnerabilityId" required>
                <option disabled value="">é€‰æ‹©æ¼æ´</option>
                <option v-for="vulnDef in vulnerabilityDefinitions" :key="vulnDef.vulnerability_id" :value="vulnDef.vulnerability_id">
                  {{ vulnDef.name }} ({{ vulnDef.cve_id }})
                </option>
              </select>
            </div>

            <!-- å›½å®¶é€‰æ‹© -->
            <div class="form-group search-container">
              <input
                type="text"
                v-model="op.countrySearch"
                placeholder="æœç´¢æˆ–é€‰æ‹©å›½å®¶"
                @input="debouncedSearchCountries(index)"
                @focus="op.showCountryResults = true"
                @blur="handleBlurCountrySearch(index)"
              />
              <ul v-if="op.showCountryResults && op.matchedCountries.length" class="search-results">
                <li v-for="country in op.matchedCountries" :key="country.country_id" @mousedown.prevent="selectCountryForRow(index, country)">
                  {{ country.country_name_zh || country.country_name }} ({{country.country_id}})
                </li>
              </ul>
              <input type="hidden" v-model="op.countryId" /> <!-- required in form logic -->
            </div>

            <!-- ASNé€‰æ‹© -->
            <div class="form-group search-container">
              <input
                type="text"
                v-model="op.asnSearch"
                placeholder="æœç´¢æˆ–é€‰æ‹©ASN"
                @input="debouncedSearchAsns(index)"
                @focus="op.showAsnResults = true"
                @blur="handleBlurAsnSearch(index)"
              />
              <ul v-if="op.showAsnResults && op.matchedAsns.length" class="search-results">
                <li v-for="asnItem in op.matchedAsns" :key="asnItem.asn" @mousedown.prevent="selectAsnForRow(index, asnItem)">
                  {{ asnItem.as_name_zh || asnItem.as_name }} (AS{{ asnItem.asn }})
                </li>
              </ul>
               <input type="hidden" v-model="op.asn" /> <!-- required in form logic -->
            </div>
            
            <!-- æ“ä½œç±»å‹é€‰æ‹© -->
            <div class="form-group">
              <select v-model="op.updateAction" required>
                <option value="set">ç›´æ¥è®¾ç½®</option>
                <option value="increment">å¢åŠ </option>
                <option value="decrement">å‡å°‘</option>
              </select>
            </div>

            <!-- æ•°å€¼è¾“å…¥ -->
            <div class="form-group">
              <input type="number" v-model.number="op.value" placeholder="æ•°é‡" required min="0" />
            </div>

            <!-- åˆ é™¤æŒ‰é’® -->
            <div>
              <button @click="removeBatchOperation(index)" class="btn btn-sm btn-danger" :disabled="batchUpdateOperations.length <= 1">
                <i class="icon-minus"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div class="form-actions mt-3">
          <button @click="addBatchOperation" class="btn btn-secondary mr-2">
            <i class="icon-plus"></i> æ·»åŠ æ›´æ–°é¡¹
          </button>
          <button @click="handleBatchUpdate" class="btn btn-primary" :disabled="isBatchSubmitting || !isBatchFormValid">
            <i class="icon-upload"></i> 
            {{ isBatchSubmitting ? 'æäº¤ä¸­...' : 'æäº¤æ‰¹é‡æ›´æ–°' }}
          </button>
        </div>
        <p class="hint mt-2">æç¤º: å¦‚æœæ›´æ–°çš„ASNå’Œæ¼æ´ç»„åˆåœ¨ç»Ÿè®¡è¡¨ä¸­ä¸å­˜åœ¨ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ›å»ºæ–°è®°å½•ã€‚æ›´æ–°ç»“æœå°†åœ¨ä¸‹æ–¹æ˜¾ç¤ºã€‚</p>
        <div v-if="batchUpdateResults.length > 0" class="batch-results mt-3">
            <h4>æ‰¹é‡æ›´æ–°ç»“æœ:</h4>
            <ul>
                <li v-for="(result, idx) in batchUpdateResults" :key="idx" :class="result.success ? 'text-success' : 'text-danger'">
                    æ“ä½œ {{ idx + 1 }}: {{ result.message }}
                    <span v-if="!result.success && result.originalOp"> (æ¼æ´: {{ getVulnNameById(result.originalOp.vulnerabilityId) }}, ASN: {{result.originalOp.asn}})</span>
                </li>
            </ul>
        </div>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted, computed, watch, nextTick } from 'vue';
import { useDatabaseStore } from '@/stores/database';
import { storeToRefs } from 'pinia';
import { debounce } from 'lodash'; 
let operationIdCounter = 0;
const store = useDatabaseStore();
const { 
  vulnerabilityDefinitions, 
  error: storeError,
  isLoading: storeLoading 
} = storeToRefs(store);

// --- å…¨å±€æ¶ˆæ¯ ---
const globalError = ref('');
const globalSuccess = ref('');

const getVulnNameById = (vulnerabilityId) => {
  if (!vulnerabilityId || !vulnerabilityDefinitions.value) return 'æœªçŸ¥æ¼æ´';
  const vuln = vulnerabilityDefinitions.value.find(v => v.vulnerability_id === vulnerabilityId);
  return vuln ? `${vuln.name} (${vuln.cve_id})` : 'æœªçŸ¥æ¼æ´';
};
// --- æ¼æ´å®šä¹‰ç®¡ç† ---
const definitionsLoading = ref(false);
const showVulnerabilityModal = ref(false);
const modalMode = ref('create'); // 'create' or 'edit'
const currentVulnerability = ref({});
const modalSubmitting = ref(false);
const modalError = ref('');

const defaultVulnerability = {
  cve_id: '',
  name: '',
  description: '',
  severity: 'medium',
  affected_protocols: '',
  detection_method: '',
  published_date: null,
};

const loadVulnerabilityDefinitions = async () => {
  console.log('[VulnerabilityManagementForm] Attempting to load vulnerability definitions...');
  definitionsLoading.value = true;
  globalError.value = ''; 
  try {
    await store.fetchVulnerabilityDefinitions();
    // Log after fetch attempt
    await nextTick(); // Ensure Vue has updated reactive values if possible
    console.log('[VulnerabilityManagementForm] Vulnerability definitions loaded. Count:', vulnerabilityDefinitions.value?.length, 'Store error:', storeError.value);
    if (storeError.value && !vulnerabilityDefinitions.value?.length) { // If there's a store error and no definitions
      globalError.value = `åŠ è½½æ¼æ´å®šä¹‰å¤±è´¥: ${storeError.value}`;
    }
  } catch (error) {
    console.error('[VulnerabilityManagementForm] Error in loadVulnerabilityDefinitions catch block:', error);
    globalError.value = `åŠ è½½æ¼æ´å®šä¹‰æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: ${error.message}`;
  } finally {
    definitionsLoading.value = false;
    console.log('[VulnerabilityManagementForm] definitionsLoading set to false.');
  }
};

const loadInitialDataForBatchOperations = async () => {
  console.log('[VulnerabilityManagementForm] Attempting to load countries for batch operations...');
  try {
    // åˆå§‹åŒ–allCountriesä¸ºç©ºæ•°ç»„ï¼Œç¡®ä¿å®ƒå§‹ç»ˆæ˜¯ä¸€ä¸ªæ•°ç»„
    allCountries.value = [];
    
    // å°è¯•åŠ è½½å›½å®¶åˆ—è¡¨ï¼Œä½¿ç”¨å¤§çš„limitè·å–æ‰€æœ‰å›½å®¶
    await store.getCountries(1, 500, '');
    console.log('[VulnerabilityManagementForm] Countries loaded from store:', store.countries?.length || 0);
    
    // ç›´æ¥ä½¿ç”¨store.countriesè€Œä¸æ˜¯countriesList
    if (store.countries && store.countries.length > 0) {
      allCountries.value = [...store.countries];
      console.log('[VulnerabilityManagementForm] Countries copied to allCountries:', allCountries.value.length);
    } else {
      console.error('[VulnerabilityManagementForm] countries is empty after getCountries call');
      globalError.value = 'æ— æ³•åŠ è½½å›½å®¶åˆ—è¡¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
    }
    
    // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ‰¹é‡æ“ä½œè¡Œçš„åŒ¹é…å›½å®¶
    if (batchUpdateOperations.value.length > 0) {
      batchUpdateOperations.value.forEach(op => {
        op.matchedCountries = allCountries.value.slice(0, 20) || [];
        console.log(`[VulnerabilityManagementForm] Initialized matchedCountries for operation:`, op.matchedCountries.length);
      });
    }
  } catch (error) {
    console.error('[VulnerabilityManagementForm] Error in loadInitialDataForBatchOperations:', error);
    globalError.value = `åŠ è½½å›½å®¶åˆ—è¡¨æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: ${error.message}`;
  }
};

function openVulnerabilityModal(mode, vuln = null) {
  modalMode.value = mode;
  modalError.value = '';
  if (mode === 'create') {
    currentVulnerability.value = { ...defaultVulnerability };
  } else {
    currentVulnerability.value = { 
      ...vuln, 
      published_date: vuln.published_date ? vuln.published_date.split('T')[0] : null 
    };
  }
  showVulnerabilityModal.value = true;
}

function closeVulnerabilityModal() {
  showVulnerabilityModal.value = false;
  currentVulnerability.value = {};
}

async function handleSaveVulnerabilityDefinition() {
  modalSubmitting.value = true;
  modalError.value = '';
  globalSuccess.value = '';
  try {
    const dataToSave = { ...currentVulnerability.value };
    if (!dataToSave.published_date) { // Handle empty date string
        delete dataToSave.published_date;
    }

    if (modalMode.value === 'create') {
      await store.createVulnerabilityDefinition(dataToSave);
      globalSuccess.value = 'æ¼æ´å®šä¹‰åˆ›å»ºæˆåŠŸ!';
    } else {
      await store.updateVulnerabilityDefinition(currentVulnerability.value.vulnerability_id, dataToSave);
      globalSuccess.value = 'æ¼æ´å®šä¹‰æ›´æ–°æˆåŠŸ!';
    }
    closeVulnerabilityModal();
    setTimeout(() => globalSuccess.value = '', 3000);
  } catch (error) {
    modalError.value = error.response?.data?.message || error.message || 'ä¿å­˜å¤±è´¥';
  } finally {
    modalSubmitting.value = false;
  }
}

async function confirmDeleteVulnerability(vuln) {
  if (window.confirm(`ç¡®å®šè¦åˆ é™¤æ¼æ´ "${vuln.name}" (CVE: ${vuln.cve_id})å—?`)) {
    definitionsLoading.value = true; // Use general loading or a specific one
    globalError.value = '';
    globalSuccess.value = '';
    try {
      await store.deleteVulnerabilityDefinition(vuln.vulnerability_id);
      globalSuccess.value = 'æ¼æ´å®šä¹‰åˆ é™¤æˆåŠŸ!';
      setTimeout(() => globalSuccess.value = '', 3000);
    } catch (error) {
      globalError.value = error.response?.data?.message || error.message || 'åˆ é™¤å¤±è´¥';
      setTimeout(() => globalError.value = '', 5000);
    } finally {
      definitionsLoading.value = false;
    }
  }
}

function getSeverityText(severity) {
  const map = { low: 'ä½', medium: 'ä¸­', high: 'é«˜', critical: 'ä¸¥é‡' };
  return map[severity.toLowerCase()] || severity;
}

function formatDate(dateString) {
  if (!dateString) return '';
  try {
    return new Date(dateString).toLocaleDateString();
  } catch (e) {
    return dateString; // fallback
  }
}

function removeBatchOperation(index) {
  if (batchUpdateOperations.value.length > 1) {
    batchUpdateOperations.value.splice(index, 1);
  }
}

// --- æ‰¹é‡æ›´æ–°ASNæ¼æ´å—å½±å“åœ°å€æ•° ---
const batchUpdateOperations = ref([createBatchOperation()]);
const isBatchSubmitting = ref(false);
const batchUpdateResults = ref([]); // To store results of batch submission

function createBatchOperation() {
  operationIdCounter++;
  return {
    id: operationIdCounter,
    vulnerabilityId: '',
    countryId: '',
    countrySearch: '',
    matchedCountries: [],
    showCountryResults: false,
    asn: '',
    asnSearch: '',
    matchedAsns: [],
    showAsnResults: false,
    updateAction: 'set',
    value: 0,
  };
}

const isBatchFormValid = computed(() => {
  return batchUpdateOperations.value.every(op => 
    op.vulnerabilityId && op.countryId && op.asn && op.updateAction && op.value >= 0
  );
});

// æ·»åŠ  resetForm å‡½æ•°å®šä¹‰
function resetForm() {
  // é‡ç½®æ‰¹é‡æ›´æ–°æ“ä½œåˆ—è¡¨ï¼Œä¿ç•™ä¸€ä¸ªç©ºè¡Œ
  batchUpdateOperations.value = [createBatchOperation()];
  // æ¸…ç©ºæ‰¹é‡æ›´æ–°ç»“æœ
  batchUpdateResults.value = [];
  // æ¸…ç©ºå…¨å±€æ¶ˆæ¯
  globalError.value = '';
  globalSuccess.value = '';
}

async function handleBatchUpdate() {
  try {
    console.log('[Form] å¼€å§‹æ‰¹é‡æ›´æ–°ï¼Œæ“ä½œæ•°é‡:', batchUpdateOperations.value.length);
    
    // éªŒè¯æ‰€æœ‰æ“ä½œ
    const validOperations = batchUpdateOperations.value.filter(op => {
      if (!op.vulnerabilityId || !op.asn || !op.updateAction || op.value === undefined) {
        console.warn('[Form] è·³è¿‡æ— æ•ˆæ“ä½œ:', op);
        return false;
      }
      return true;
    });

    if (validOperations.length === 0) {
      globalError.value = 'æ²¡æœ‰æœ‰æ•ˆçš„æ›´æ–°æ“ä½œ';
      return;
    }

    // å‡†å¤‡æ‰¹é‡æ›´æ–°æ•°æ®
    const operations = validOperations.map(op => ({
      vulnerabilityId: op.vulnerabilityId,
      asn: op.asn,
      updateAction: op.updateAction,
      value: Number(op.value)
    }));

    console.log('[Form] æäº¤æ‰¹é‡æ›´æ–°æ“ä½œ:', operations);
    
    // è°ƒç”¨storeçš„æ‰¹é‡æ›´æ–°æ–¹æ³•
    const result = await store.batchUpdateAsnVulnerabilityStats(operations);
    console.log('[Form] æ‰¹é‡æ›´æ–°ç»“æœ:', result);

    // å¤„ç†æ›´æ–°ç»“æœ
    if (result.success) {
      // å®Œå…¨æˆåŠŸ
      globalSuccess.value = result.message || 'æ‰¹é‡æ›´æ–°æˆåŠŸ';
      // å°†ç»“æœæ·»åŠ åˆ°æ‰¹é‡æ›´æ–°ç»“æœåˆ—è¡¨
      batchUpdateResults.value = result.results.map(op => ({
        success: true,
        message: `æ“ä½œæˆåŠŸ: ${getVulnNameById(op.vulnerabilityId)} (ASN: ${op.asn}) - ${op.message || 'æ›´æ–°æˆåŠŸ'}`,
        originalOp: op
      }));
      // é‡ç½®è¡¨å•
      resetForm();
    } else {
      // éƒ¨åˆ†æˆåŠŸæˆ–å®Œå…¨å¤±è´¥
      const failedOperations = result.results.filter(r => !r.success);
      if (failedOperations.length > 0) {
        // æ„å»ºé”™è¯¯æ¶ˆæ¯
        const errorMessages = failedOperations.map(op => {
          const vulnerability = vulnerabilityDefinitions.value.find(v => v.vulnerability_id === op.vulnerabilityId);
          const asn = allAsns.value.find(a => a.asn === op.asn);
          return {
            success: false,
            message: `æ“ä½œå¤±è´¥: ${vulnerability?.name || 'æœªçŸ¥æ¼æ´'} (ASN: ${asn?.asn || op.asn}) - ${op.message || 'æœªçŸ¥é”™è¯¯'}`,
            originalOp: op
          };
        });
        // å°†æˆåŠŸå’Œå¤±è´¥çš„æ“ä½œéƒ½æ·»åŠ åˆ°ç»“æœåˆ—è¡¨
        batchUpdateResults.value = [
          ...result.results.filter(r => r.success).map(op => ({
            success: true,
            message: `æ“ä½œæˆåŠŸ: ${getVulnNameById(op.vulnerabilityId)} (ASN: ${op.asn}) - ${op.message || 'æ›´æ–°æˆåŠŸ'}`,
            originalOp: op
          })),
          ...errorMessages
        ];
        globalError.value = 'éƒ¨åˆ†æ“ä½œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ç»“æœ';
      } else {
        globalError.value = result.message || 'æ‰¹é‡æ›´æ–°å¤±è´¥';
        batchUpdateResults.value = result.results.map(op => ({
          success: false,
          message: `æ“ä½œå¤±è´¥: ${getVulnNameById(op.vulnerabilityId)} (ASN: ${op.asn}) - ${result.message || 'æ›´æ–°å¤±è´¥'}`,
          originalOp: op
        }));
      }
    }
  } catch (error) {
    console.error('[Form] æ‰¹é‡æ›´æ–°å¤±è´¥:', error);
    globalError.value = error.message || 'æ‰¹é‡æ›´æ–°æ“ä½œå¤±è´¥';
    batchUpdateResults.value = [{
      success: false,
      message: `æ“ä½œå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`,
      originalOp: null
    }];
  }
}

// --- å›½å®¶å’ŒASNæœç´¢é€»è¾‘ ---
const allCountries = ref([]); // Store all countries fetched once
const allAsns = ref([]); // å­˜å‚¨æ‰€æœ‰ASN

async function loadInitialDataForSelectors() {
  try {
    // åŠ è½½å›½å®¶åˆ—è¡¨ï¼Œä½¿ç”¨è¾ƒå¤§çš„limitä»¥è·å–æ‰€æœ‰å›½å®¶
    await store.getCountries(1, 500, '');
    // ç›´æ¥ä½¿ç”¨storeçš„countriesè€Œä¸æ˜¯countriesList
    allCountries.value = store.countries || [];
    console.log('[VulnerabilityManagementForm] åŠ è½½å›½å®¶åˆ—è¡¨å®Œæˆï¼Œæ•°é‡:', allCountries.value.length);
    
    // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ‰¹é‡æ“ä½œè¡Œçš„åŒ¹é…å›½å®¶ - æ˜¾ç¤ºæ‰€æœ‰å›½å®¶
    if (batchUpdateOperations.value.length > 0) {
      batchUpdateOperations.value.forEach(op => {
        op.matchedCountries = allCountries.value.slice(0, 20) || [];
      });
    }
    
    // é¢„åŠ è½½ASNæ•°æ®
    try {
      console.log('[Form] å¼€å§‹é¢„åŠ è½½ASNæ•°æ®...');
      const asnsData = await store.getAllAsns(1, 20); // è·å–å‰20ä¸ªASN
      console.log('[Form] é¢„åŠ è½½ASNæ•°æ®æˆåŠŸï¼Œå“åº”:', asnsData);
      
      // ç¡®ä¿asnsDataæ˜¯æ•°ç»„ä¸”ä¸ä¸ºç©º
      if (Array.isArray(asnsData) && asnsData.length > 0) {
        console.log('[Form] é¢„åŠ è½½ASNæ•°æ®æˆåŠŸï¼Œæ•°é‡:', asnsData.length);
        allAsns.value = asnsData;
        
        // åˆå§‹åŒ–æ¯ä¸ªæ“ä½œè¡Œçš„ASNåˆ—è¡¨
        if (batchUpdateOperations.value.length > 0) {
          batchUpdateOperations.value.forEach(op => {
            op.matchedAsns = [...asnsData]; // å¤åˆ¶é¢„åŠ è½½çš„ASNåˆ°æ¯ä¸ªæ“ä½œè¡Œ
            console.log(`[Form] åˆå§‹åŒ–: ä¸ºæ“ä½œè¡Œè®¾ç½®äº†${op.matchedAsns.length}ä¸ªASN`);
          });
        } else {
          console.warn('[Form] æ— æ³•åˆå§‹åŒ–ASNåˆ—è¡¨: æ“ä½œè¡Œä¸ºç©º');
        }
      } else {
        console.warn('[Form] é¢„åŠ è½½ASNæ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®:', asnsData);
        allAsns.value = [];
        // åˆå§‹åŒ–ç©ºæ•°ç»„
        if (batchUpdateOperations.value.length > 0) {
          batchUpdateOperations.value.forEach(op => {
            op.matchedAsns = [];
          });
        }
      }
    } catch (error) {
      console.error('[Form] é¢„åŠ è½½ASNæ•°æ®å¤±è´¥:', error);
      globalError.value = 'åŠ è½½ASNåˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
      allAsns.value = [];
      // åˆå§‹åŒ–ç©ºæ•°ç»„
      if (batchUpdateOperations.value.length > 0) {
        batchUpdateOperations.value.forEach(op => {
          op.matchedAsns = [];
        });
      }
    }
  } catch (error) {
    console.error('[Form] åŠ è½½é€‰æ‹©å™¨åˆå§‹æ•°æ®å¤±è´¥:', error);
    globalError.value = 'åŠ è½½åˆå§‹æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
  }
}

function _debounce(fn, delay) {
  let timeoutID = null;
  return function(...args) {
    clearTimeout(timeoutID);
    timeoutID = setTimeout(() => {
      fn.apply(this, args);
    }, delay);
  };
}

const debouncedSearchCountries = _debounce((rowIndex) => {
  const op = batchUpdateOperations.value[rowIndex];
  if (!op) return;
  
  console.log(`[Country Search] Searching for: "${op.countrySearch}" in ${allCountries.value.length} countries`);
  
  const searchTerm = op.countrySearch.toLowerCase();
  if (!searchTerm) {
    // ç§»é™¤20ä¸ªé™åˆ¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›½å®¶
    op.matchedCountries = [...allCountries.value];
    return;
  }
  
  op.matchedCountries = allCountries.value.filter(country => {
    const nameCN = (country.country_name_zh || '').toLowerCase();
    const nameEN = (country.country_name || '').toLowerCase();
    const id = (country.country_id || '').toLowerCase();
    return nameCN.includes(searchTerm) || nameEN.includes(searchTerm) || id.includes(searchTerm);
  });
}, 300);

//æœç´¢ASN
const searchAsns = async (index) => {
  const op = batchUpdateOperations.value[index];
  console.log(`[Form] æœç´¢ASN: è¡Œ=${index}, æŸ¥è¯¢='${op.asnSearch}', å›½å®¶ID=${op.countryId || 'none'}`);
  
  try {
    let asns = [];
    
    if (op.asnSearch && op.asnSearch.length >= 2) {
      // å¦‚æœæœ‰æœç´¢è¯ï¼Œæ ¹æ®æœç´¢è¯æŸ¥è¯¢
      console.log(`[Form] é€šè¿‡æœç´¢è¯æŸ¥è¯¢ASN: ${op.asnSearch}`);
      asns = await store.searchAsns(op.asnSearch, op.countryId);
    } else if (op.countryId) {
      // å¦‚æœæœ‰å›½å®¶IDä½†æ²¡æœ‰æœç´¢è¯ï¼Œè·å–è¯¥å›½å®¶çš„ASN
      console.log(`[Form] è·å–å›½å®¶çš„ASN: ${op.countryId}`);
      asns = await store.fetchAsnsByCountry(op.countryId);
    } else {
      // å¦‚æœæ—¢æ²¡æœ‰å›½å®¶IDä¹Ÿæ²¡æœ‰æœç´¢è¯ï¼Œè·å–æ‰€æœ‰ASN
      console.log(`[Form] è·å–æ‰€æœ‰ASN (æ— å›½å®¶IDå’Œæœç´¢è¯)`);
      const response = await store.getAllAsns(1, 1000); // å¢åŠ è·å–æ•°é‡
      asns = response.data || [];
    }
    
    console.log(`[Form] è·å–åˆ°ASNæ•°é‡: ${asns.length}`);
    op.matchedAsns = asns.slice(0, 20);
    
    if (op.matchedAsns.length === 0 && op.asnSearch) {
      console.warn(`[Form] æœªæ‰¾åˆ°åŒ¹é…çš„ASN: ${op.asnSearch}`);
    }
  } catch (error) {
    console.error(`[Form] æœç´¢ASNå¤±è´¥:`, error);
    op.matchedAsns = [];
  }
};

// åˆå§‹åŒ–æ‰¹é‡æ“ä½œè¡Œæ—¶åŠ è½½ASN
const initializeRowAsns = async (index) => {
  const op = batchUpdateOperations.value[index];
  console.log(`[Form] åˆå§‹åŒ–è¡Œ${index}çš„ASNåˆ—è¡¨`);
  
  try {
    // é»˜è®¤åŠ è½½ä¸€äº›ASNï¼Œæ— è®ºæ˜¯å¦æœ‰å›½å®¶ID
    let asns = [];
    
    if (op.countryId) {
      console.log(`[Form] åˆå§‹åŒ–: åŠ è½½å›½å®¶${op.countryId}çš„ASN`);
      asns = await store.fetchAsnsByCountry(op.countryId);
    } else {
      console.log(`[Form] åˆå§‹åŒ–: åŠ è½½æ‰€æœ‰ASN (æ— å›½å®¶ID)`);
      asns = await store.getAllAsns(1, 20);
    }
    
    console.log(`[Form] åˆå§‹åŒ–: è·å–åˆ°${asns.length}ä¸ªASN`);
    op.matchedAsns = asns.slice(0, 20);
  } catch (error) {
    console.error(`[Form] åˆå§‹åŒ–ASNåˆ—è¡¨å¤±è´¥:`, error);
    op.matchedAsns = [];
  }
};
  
// å½“æ·»åŠ æ–°çš„æ‰¹é‡æ“ä½œè¡Œæ—¶ï¼Œåˆå§‹åŒ–ASN
const addBatchOperation = () => {
  const newOp = createBatchOperation();
  batchUpdateOperations.value.push(newOp);
  
  // åˆå§‹åŒ–æ–°è¡Œçš„å›½å®¶å’ŒASNåˆ—è¡¨
  nextTick(() => {
    const index = batchUpdateOperations.value.length - 1;
    if (allCountries.value.length > 0) {
      batchUpdateOperations.value[index].matchedCountries = allCountries.value.slice(0, 20);
    }
    
    // åˆå§‹åŒ–ASNåˆ—è¡¨ï¼Œå³ä½¿æ²¡æœ‰é€‰æ‹©å›½å®¶
    initializeRowAsns(index);
  });
};

// å½“é€‰æ‹©å›½å®¶æ—¶ï¼Œæ›´æ–°ASNåˆ—è¡¨
const selectCountryForRow = (index, country) => {
  const op = batchUpdateOperations.value[index];
  op.countryId = country.country_id;
  op.countrySearch = country.country_name_zh || country.country_name;
  op.showCountryResults = false;
  
  // å½“é€‰æ‹©å›½å®¶åï¼Œæ›´æ–°ASNåˆ—è¡¨
  console.log(`[Form] é€‰æ‹©å›½å®¶åæ›´æ–°ASNåˆ—è¡¨: å›½å®¶=${country.country_id}`);
  nextTick(() => {
    searchAsns(index);
  });
};



// å½“å›½å®¶æœç´¢æ¡†å¤±å»ç„¦ç‚¹æ—¶
const handleBlurCountrySearch = (index) => {
  // å»¶è¿Ÿå…³é—­ä¸‹æ‹‰èœå•ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥ç‚¹å‡»é€‰é¡¹
  setTimeout(() => {
    batchUpdateOperations.value[index].showCountryResults = false;
  }, 200);
};

// å½“ASNæœç´¢æ¡†å¤±å»ç„¦ç‚¹æ—¶
const handleBlurAsnSearch = (index) => {
  // å»¶è¿Ÿå…³é—­ä¸‹æ‹‰èœå•ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥ç‚¹å‡»é€‰é¡¹
  setTimeout(() => {
    batchUpdateOperations.value[index].showAsnResults = false;
  }, 200);
};


const debouncedSearchAsns = debounce(async (index) => {
  const op = batchUpdateOperations.value[index];
  const query = op.asnSearch.trim();
  
  try {
    console.log(`[ASN Search] Searching ASNs with query: '${query}', country: ${op.countryId || 'none'}`);
    
    let asnsData = [];
    if (query && query.length >= 2) {
      // å¦‚æœæœ‰æœç´¢è¯ï¼Œä½¿ç”¨æœç´¢API
      asnsData = await store.searchAsns(query, op.countryId);
      console.log(`[ASN Search] Searched ASNs with query '${query}', found ${asnsData.length}`);
    } else if (op.countryId) {
      // å¦‚æœæœ‰å›½å®¶IDä½†æ²¡æœ‰æœç´¢è¯ï¼Œè·å–è¯¥å›½å®¶çš„ASN
      asnsData = await store.fetchAsnsByCountry(op.countryId);
      console.log(`[ASN Search] Fetched ${asnsData.length} ASNs for country ${op.countryId}`);
    } else {
      // å¦‚æœæ—¢æ²¡æœ‰å›½å®¶IDä¹Ÿæ²¡æœ‰æœç´¢è¯ï¼Œè·å–æ‰€æœ‰ASN
      const response = await store.getAllAsns(1, 1000);
      asnsData = response.data || [];
      console.log(`[ASN Search] Fetched all ASNs, count: ${asnsData.length}`);
    }
    
    op.matchedAsns = asnsData;
  } catch (error) {
    console.error('[ASN Search] Error:', error);
    op.matchedAsns = [];
  }
}, 300);

// æ ¹æ®å›½å®¶IDæœç´¢ASN
async function searchAsnsByCountry(rowIndex) {
  const op = batchUpdateOperations.value[rowIndex];
  if (!op || !op.countryId) return;
  
  try {
    const results = await store.fetchAsnsByCountry(op.countryId);
    op.matchedAsns = results;
    console.log(`[ASN Search] Found ${results.length} ASNs for country ${op.countryId}`);
  } catch (error) {
    console.error(`[ASN Search] Error fetching ASNs for country ${op.countryId}:`, error);
    op.matchedAsns = [];
  }
}



function selectAsnForRow(index, asnItem) {
  const op = batchUpdateOperations.value[index];
  op.asn = asnItem.asn;
  op.asnSearch = `${asnItem.as_name_zh || asnItem.as_name} (AS${asnItem.asn})`;
  op.showAsnResults = false;
  
  // å¦‚æœASNæœ‰å›½å®¶ä¿¡æ¯ï¼Œå¼ºåˆ¶è®¾ç½®å›½å®¶
  if (asnItem.country_id) {
    const country = allCountries.value.find(c => c.country_id === asnItem.country_id);
    if (country) {
      op.countryId = country.country_id;
      op.countrySearch = country.country_name_zh || country.country_name;
      console.log(`[ASN Selection] Set country to ${op.countryId} (${op.countrySearch}) based on selected ASN`);
    } else {
      // å¦‚æœåœ¨æœ¬åœ°æ‰¾ä¸åˆ°å›½å®¶ä¿¡æ¯ï¼Œå°è¯•ä»æœåŠ¡å™¨è·å–
      store.getCountries().then(() => {
        const updatedCountry = allCountries.value.find(c => c.country_id === asnItem.country_id);
        if (updatedCountry) {
          op.countryId = updatedCountry.country_id;
          op.countrySearch = updatedCountry.country_name_zh || updatedCountry.country_name;
          console.log(`[ASN Selection] Set country to ${op.countryId} (${op.countrySearch}) after fetching countries`);
        }
      });
    }
  }
}


onMounted(async () => {
  console.log('[VulnerabilityManagementForm] Component mounted, loading initial data...');
  await loadVulnerabilityDefinitions();
  await loadInitialDataForBatchOperations(); // ç¡®ä¿å›½å®¶åˆ—è¡¨å·²åŠ è½½
  await loadInitialDataForSelectors(); 
  
  // æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œæ£€æŸ¥ASNæ•°æ®æ˜¯å¦æ­£ç¡®åŠ è½½
  console.log('[Form] åˆå§‹åŒ–: è·å–åˆ°', allAsns.value?.length || 0, 'ä¸ªASN');
  console.log('[Form] åˆå§‹åŒ–: ç¬¬ä¸€ä¸ªæ“ä½œè¡Œçš„matchedAsnsé•¿åº¦:', 
    batchUpdateOperations.value[0]?.matchedAsns?.length || 0);
  
  // ç¡®ä¿allCountrieså·²åˆå§‹åŒ–
  if (!allCountries.value || allCountries.value.length === 0) {
    console.warn('[VulnerabilityManagementForm] allCountries is empty after initialization, trying again...');
    // å¦‚æœstore.countriesæœ‰å€¼ä½†allCountriesæ²¡æœ‰ï¼Œå°è¯•å†æ¬¡å¤åˆ¶
    if (store.countries && store.countries.length > 0) {
      allCountries.value = [...store.countries];
      console.log('[VulnerabilityManagementForm] Copied store.countries to allCountries:', allCountries.value.length);
    }
  }
  
  // ç¡®ä¿allAsnså·²åˆå§‹åŒ–
  if (!allAsns.value || allAsns.value.length === 0) {
    console.warn('[Form] allAsnsä¸ºç©ºï¼Œå°è¯•é‡æ–°åŠ è½½...');
    try {
      const response = await store.getAllAsns(1, 20);
      const asnsData = response.data?.data || [];
      allAsns.value = asnsData;
      console.log('[Form] é‡æ–°åŠ è½½ASNæˆåŠŸï¼Œæ•°é‡:', allAsns.value.length);
      
      // æ›´æ–°æ“ä½œè¡Œçš„ASNåˆ—è¡¨
      if (batchUpdateOperations.value.length > 0) {
        batchUpdateOperations.value[0].matchedAsns = [...allAsns.value];
      }
    } catch (error) {
      console.error('[Form] é‡æ–°åŠ è½½ASNå¤±è´¥:', error);
    }
  }

  console.log('[VulnerabilityManagementForm] Initial data loading complete.');
});

// Watch for store errors to update globalError
watch(storeError, (newError) => {
  if (newError && !definitionsLoading.value && !modalSubmitting.value && !isBatchSubmitting.value) {
    // Only show if not related to an active operation that has its own error display
    globalError.value = newError;
  }
});

</script>

<style scoped>
/* å…¨å±€æ ·å¼ */
.vulnerability-management-form {
  font-family: 'Arial', sans-serif;
  color: #333;
}

.card {
  background-color: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}

.card-header {
  background-color: #f8f9fa;
  padding: 12px 20px;
  border-bottom: 1px solid #e0e0e0;
  font-size: 1.1em;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header .icon-list,
.card-header .icon-update {
  margin-right: 8px;
}

.card-body {
  padding: 20px;
}

/* æ¶ˆæ¯æç¤º */
.error-message, .success-message {
  padding: 10px 15px;
  margin-bottom: 15px;
  border-radius: 4px;
  font-size: 0.9em;
}
.global-error, .global-success {
  margin: 0 0 20px 0; /* Adjust margin for global messages if they are outside cards */
}
.error-message {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
.success-message {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}
.loading-message {
  color: #555;
  padding: 20px;
  text-align: center;
}

/* è¡¨æ ¼æ ·å¼ */
.table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1rem;
}
.table th, .table td {
  padding: 0.75rem;
  vertical-align: top;
  border-top: 1px solid #dee2e6;
  text-align: left;
}
.table thead th {
  vertical-align: bottom;
  border-bottom: 2px solid #dee2e6;
  background-color: #f8f9fa;
}
.table-striped tbody tr:nth-of-type(odd) {
  background-color: rgba(0,0,0,.03);
}
.table-hover tbody tr:hover {
  background-color: rgba(0,0,0,.06);
}

/* æŒ‰é’®æ ·å¼ */
.btn {
  display: inline-block;
  font-weight: 400;
  text-align: center;
  vertical-align: middle;
  user-select: none;
  background-color: transparent;
  border: 1px solid transparent;
  padding: 0.375rem 0.75rem;
  font-size: 0.9rem;
  line-height: 1.5;
  border-radius: 0.25rem;
  transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
  cursor: pointer;
}
.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.7875rem;
  line-height: 1.5;
  border-radius: 0.2rem;
}
.btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }
.btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
.btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; }
.btn-secondary:hover { background-color: #545b62; border-color: #545b62; }
.btn-success { color: #fff; background-color: #28a745; border-color: #28a745; }
.btn-success:hover { background-color: #1e7e34; border-color: #1e7e34; }
.btn-info { color: #fff; background-color: #17a2b8; border-color: #17a2b8; }
.btn-info:hover { background-color: #117a8b; border-color: #117a8b; }
.btn-danger { color: #fff; background-color: #dc3545; border-color: #dc3545; }
.btn-danger:hover { background-color: #bd2130; border-color: #bd2130; }
.btn:disabled { opacity: 0.65; cursor: not-allowed; }
.float-right { float: right; }
.mr-1 { margin-right: 0.25rem !important; }
.mr-2 { margin-right: 0.5rem !important; }
.mt-2 { margin-top: 0.5rem !important; }
.mt-3 { margin-top: 1rem !important; }
.mt-4 { margin-top: 1.5rem !important; }

/* è¡¨å•å…ƒç´  */
.form-group {
  margin-bottom: 1rem;
}
.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}
.form-group input[type="text"],
.form-group input[type="number"],
.form-group input[type="date"],
.form-group select,
.form-group textarea {
  display: block;
  width: 100%;
  padding: 0.5rem 0.75rem;
  font-size: 0.9rem;
  line-height: 1.5;
  color: #495057;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
  box-sizing: border-box; /* Important for width 100% */
}
.form-group textarea {
  min-height: 80px;
  resize: vertical;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  border-color: #80bdff;
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}
.required {
  color: #dc3545;
  margin-left: 2px;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background-color: #fff;
  padding: 25px;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.modal-content h4 {
  margin-top: 0;
  margin-bottom: 1.5rem;
  font-size: 1.25em;
}
.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px; /* Spacing between buttons */
  margin-top: 1.5rem;
}

/* ä¸¥é‡ç¨‹åº¦å¾½ç«  */
.severity-badge {
  padding: 0.25em 0.6em;
  font-size: 75%;
  font-weight: 700;
  line-height: 1;
  text-align: center;
  white-space: nowrap;
  vertical-align: baseline;
  border-radius: 0.25rem;
  color: #fff;
}
.severity-low { background-color: #28a745; } /* Green */
.severity-medium { background-color: #ffc107; color: #212529;} /* Yellow */
.severity-high { background-color: #fd7e14; } /* Orange */
.severity-critical { background-color: #dc3545; } /* Red */


/* æ‰¹é‡æ›´æ–°è¡¨æ ¼åŒ–å¸ƒå±€ */
.batch-operations-table .form-group {
  width: 100%;
  margin-bottom: 0;
}

.batch-operations-table .form-group input,
.batch-operations-table .form-group select {
  width: 100%;
  height: 38px;
  padding: 6px 12px;
  font-size: 14px;
  line-height: 1.5;
  border: 1px solid #ced4da;
  border-radius: 4px;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.batch-operations-header {
  display: grid;
  grid-template-columns: 2fr 1.5fr 1.5fr 1fr 1fr 40px;
  gap: 10px;
  padding: 10px 0;
  font-weight: bold;
  border-bottom: 2px solid #eee;
}

.batch-operation-row {
  display: grid;
  grid-template-columns: 2fr 1.5fr 1.5fr 1fr 1fr 40px;
  gap: 10px;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
  align-items: center;
}

/* æœç´¢ç»“æœä¸‹æ‹‰æ¡†æ ·å¼ */
.search-container {
  position: relative;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  max-height: 300px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ced4da;
  border-radius: 0 0 4px 4px;
  z-index: 1000;
  padding: 0;
  margin: 0;
  list-style: none;
}

.search-results li {
  padding: 8px 12px;
  cursor: pointer;
}

.search-results li:hover {
  background-color: #f8f9fa;
}

/* æ‰¹é‡æ›´æ–°ç»“æœ */
.batch-results {
  margin-top: 20px;
  padding: 15px;
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
}
.batch-results h4 {
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 1.1em;
  color: #495057;
}
.batch-results ul {
  list-style-type: none;
  padding-left: 0;
  margin-bottom: 0;
}
.batch-results li {
  padding: 8px 0;
  font-size: 0.95em;
  border-bottom: 1px solid #e9ecef;
}
.batch-results li:last-child {
  border-bottom: none;
}
.batch-results .text-success {
  color: #28a745;
}
.batch-results .text-danger {
  color: #dc3545;
}

.hint {
  font-size: 0.85em;
  color: #666;
  margin-top: 10px;
}

/* å›¾æ ‡ (å‡è®¾ä½ ä½¿ç”¨äº†ç±»ä¼¼FontAwesomeçš„å›¾æ ‡ç±») */
[class^="icon-"], [class*=" icon-"] {
  /* åŸºæœ¬çš„å›¾æ ‡æ ·å¼ï¼Œå…·ä½“éœ€è¦æ ¹æ®ä½ çš„å›¾æ ‡åº“è°ƒæ•´ */
  display: inline-block;
  font-family: 'your-icon-font'; /* æ›¿æ¢ä¸ºä½ çš„å›¾æ ‡å­—ä½“å */
  font-style: normal;
  font-weight: normal;
  font-variant: normal;
  text-transform: none;
  line-height: 1;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
/* ç¤ºä¾‹å›¾æ ‡ - ä½ éœ€è¦ç”¨ä½ çš„å›¾æ ‡åº“çš„å®é™…unicodeæˆ–ç±»åæ›¿æ¢ */
.icon-list:before { content: "ğŸ“‹"; }
.icon-plus:before { content: "â•"; }
.icon-edit:before { content: "âœï¸"; }
.icon-delete:before { content: "ğŸ—‘ï¸"; }
.icon-update:before { content: "ğŸ”„"; }
.icon-minus:before { content: "â–"; }
.icon-upload:before { content: "ğŸ“¤"; }

</style>