<template>
  <div class="detection-platform">
    <div class="search-container">
      <button class="search-button" @click="searchVisible = !searchVisible">
        <i class="search-icon">🔍</i> 搜索
      </button>
      <SearchPanel 
        v-model:visible="searchVisible"
        @search="handleSearch"
      />
    </div>
    
    <header class="platform-header">
      <h1>IPv6网络探测平台</h1>
      
      <div class="header-right">
        <div class="time-display">{{ currentTime }}</div>
        <div v-if="!authStore.isAuthenticated" class="auth-actions">
          <button @click="goToLogin" class="btn btn-primary">登录</button>
          <button @click="showGuestTooltip = true" class="btn btn-tools">工具平台</button>
          <div v-if="showGuestTooltip" class="tooltip">请登录后使用工具平台</div>
        </div>
        <div v-else class="auth-actions">
          <span class="username">欢迎，{{ authStore.username }}</span>
          <button @click="goToTools" class="btn btn-tools">工具平台</button>
          <button @click="handleLogout" class="btn btn-secondary">退出</button>
        </div>
      </div>
    </header>
    
    <main class="platform-main">
      <div v-if="!authStore.isAuthenticated" class="guest-notice">
        <h2>访客模式</h2>
        <p>您当前以访客身份访问，可以查询公开的IPv6地址信息。</p>
        <p>登录后可解锁更多功能，包括XMap探测工具等。</p>
      </div>
      
      <div class="detection-container">
        <GlobeMap 
          ref="globeMap"
          :countries="detectionStore.countries"
          :asns="detectionStore.asns"
          @country-selected="handleCountrySelect"
          @asn-selected="handleAsnSelect"
        />
        
        <div class="ranking-panels">
          <SidePanel 
            title="国家排名" 
            :items="detectionStore.countryRanking" 
            initial-position="{ x: 10, y: 10 }"
            @item-selected="handleCountrySelect"
          />
          <SidePanel 
            title="ASN排名"
            :items="detectionStore.asnRanking" 
            initial-position="{ x: 20, y: 45 }"
            @item-selected="handleAsnSelect"
          />
        </div>
        
        <transition name="slide">
          <div v-if="selectedItem" class="detail-panel">
            <CountryDetail 
              v-if="selectedItem.type === 'country'" 
              :data="selectedItem.data"
              @close="selectedItem = null"
            />
            <AsnDetail 
              v-else-if="selectedItem.type === 'asn'"
              :data="selectedItem.data"
              @close="selectedItem = null"
            />
          </div>
        </transition>
      </div>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { useDetectionStore } from '@/stores/detection'
import GlobeMap from '@/components/detection/GlobeMap.vue'
import SidePanel from '@/components/detection/SidePanel.vue'
import CountryDetail from '@/components/detection/CountryDetail.vue'
import AsnDetail from '@/components/detection/AsnDetail.vue'
import SearchPanel from '@/components/detection/SearchPanel.vue'

const router = useRouter()
const authStore = useAuthStore()
const detectionStore = useDetectionStore()
const globeMap = ref(null)

// 数据状态
const currentTime = ref('')
const searchVisible = ref(false)
const selectedItem = ref(null)
const showGuestTooltip = ref(false)

// 初始化数据
onMounted(async () => {
  try {
    // 确保地图数据最先加载
    await detectionStore.fetchMapData()
    
    // 并行加载其他数据
    await Promise.allSettled([
      detectionStore.fetchCountryRanking(),
      detectionStore.fetchAsnRanking()
    ])
  } catch (error) {
    console.error('初始化失败:', error)
  }
  
  await Promise.all([
    detectionStore.fetchMapData(),
    detectionStore.fetchCountryRanking(),
    detectionStore.fetchAsnRanking()
  ])
  updateTime()
  setInterval(updateTime, 1000)
})

// 更新时间显示
const updateTime = () => {
  const now = new Date()
  currentTime.value = now.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  })
}

// 处理国家选择
const handleCountrySelect = (country) => {
  selectedItem.value = {
    type: 'country',
    data: country
  }
  if (globeMap.value) {
    globeMap.value.flyToCountry(country.country_id)
  }
}

// 处理ASN选择
const handleAsnSelect = (asn) => {
  selectedItem.value = {
    type: 'asn',
    data: asn
  }
  if (globeMap.value) {
    globeMap.value.flyToAsn(asn.asn)
  }
}

// 处理搜索
const handleSearch = (result) => {
  if (result.type === 'country') {
    handleCountrySelect(result.data)
  } else if (result.type === 'asn') {
    handleAsnSelect(result.data)
  }
}

// 导航控制
const goToLogin = () => {
  router.push('/login')
}

const goToTools = () => {
  router.push('/tools')
}

// 退出登录
const handleLogout = async () => {
  try {
    await authStore.logout()
    router.push('/login')
  } catch (error) {
    console.error('退出登录失败:', error)
  }
}


</script>

<style scoped>

.platform-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0.3);
  z-index: 100;
}

.platform-header h1 {
  margin: 0;
  font-size: 24px;
  color: #4fc3f7;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 20px;
}

.time-display {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.8);
}

.auth-actions {
  display: flex;
  gap: 10px;
  align-items: center;
  position: relative;
}

.username {
  color: rgba(255, 255, 255, 0.8);
  font-size: 14px;
}

.tooltip {
  position: absolute;
  top: 100%;
  right: 0;
  background: #ff4757;
  color: white;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
}

.guest-notice {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 2rem;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 8px;
  text-align: center;
  z-index: 100;
  max-width: 500px;
}

.guest-notice h2 {
  margin-bottom: 1rem;
  color: #4fc3f7;
}

.guest-notice p {
  margin-bottom: 0.5rem;
  color: rgba(255, 255, 255, 0.7);
}

.platform-main {
  height: calc(100vh - 60px);
  position: relative;
}

.detection-container {
  position: relative;
  width: 100%;
  height: 100%;
}

.ranking-panels {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 20px;
  z-index: 10;
}

.country-panel {
  animation: slideInLeft 0.5s ease-out;
}

.asn-panel {
  animation: slideInLeft 0.7s ease-out;
}

.detail-panel {
  position: absolute;
  bottom: 20px;
  left: 20px;
  width: 400px;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 5px;
  padding: 15px;
  z-index: 100;
  box-shadow: 0 0 20px rgba(0, 150, 255, 0.3);
}

/* 按钮样式 */
.btn {
  padding: 8px 16px;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.btn-primary {
  background: #4fc3f7;
  color: white;
}

.btn-primary:hover {
  background: #3db8e8;
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
}

.btn-tools {
  background: #42b983;
  color: white;
}

.btn-tools:hover {
  background: #3aa876;
}

/* 动画 */
@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.slide-enter-active,
.slide-leave-active {
  transition: all 0.3s ease;
}

.slide-enter-from,
.slide-leave-to {
  transform: translateY(20px);
  opacity: 0;
}

.btn-search {
  background: #42b983;
  margin-left: auto; /* 使按钮靠右 */
  margin-right: 15px;
}

.icon-search:before {
  content: "🔍";
  margin-right: 5px;
}

.no-select {
  user-select: none;
  -webkit-user-select: none;
}

.search-container {
  position: absolute;
  top: 80px;
  right: 120px;
  z-index: 1000;
  display: flex;          /* 添加 flex 布局 */
  flex-direction: row-reverse; /* 反转子元素顺序 */
  gap: 8px;              /* 添加元素间距 */
}

.search-button {
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: 1px solid #4fc3f7;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  /* 移除 margin-left 如果有的话 */
  order: 1; /* 确保按钮在 flex 布局中位于右侧 */
}

.search-button:hover {
  background: rgba(79, 195, 247, 0.2);
}

.search-icon {
  font-size: 16px;
}
.detection-platform {
  position: relative;
  width: 100%;
  height: 100vh;
  background-image: url('/images/background.jpg');
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  color: white;
  overflow: hidden;
}

/* 添加半透明遮罩增强文字可读性 */
.detection-platform::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 0;
}

/* 确保内容在遮罩上方 */
.platform-header,
.platform-main {
  position: relative;
  z-index: 1;
}

</style>